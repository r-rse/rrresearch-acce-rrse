{
  "hash": "ade3ee0a517b3ac64ebe0d5bb6bdb58e",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Data visualisation in practice\"\nsubtitle: \"Exploring `individual` with `ggplot2`\"\n---\n\n\n**Now let's start putting some the tools and concepts we just learned to use with our `data/individual.csv` data.**\n\nLet's say we are interested in exploring the **relationship between individual plant `stem_diameter` and `height`.**\n\nLet's also say that, from previous knowledge, **we expect that the relationship may vary according to the `growth_form`.**\n\nSo lets use data visualisation to explore the properties and relationships between the three variables.\n\n## Create `analysis.R` script\n\n**Let's create a new `.R` script and save it as `analysis.R` in the root of our project.**\n\n### Load packages & data\n\nLet's add some setup code to our `analysis.R` script.\n\nStart by **loading the `ggplot2` as well as package `dplyr`** so we have access to the pipe and other data munging functionality. \n\nLet's **read in the data and also narrow it down to our variables of interest** using the `select()` function.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## Setup ----\n# Load libraries\nlibrary(dplyr)\nlibrary(ggplot2)\n# Load data\nindividual <- readr::read_csv(\n  here::here(\"data\", \"individual.csv\")\n) %>%\n  select(stem_diameter, height, growth_form)\n```\n:::\n\n\n# Exploratory Data Analysis\n\nBefore we start exploring the relationship between variables, it's important to understand the statistical properties of the underlying data. Statistical summaries such as the output of `summary()` are a good starting point.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsummary(individual)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n stem_diameter        height       growth_form       \n Min.   :  1.00   Min.   :  0.30   Length:14961      \n 1st Qu.: 11.60   1st Qu.:  5.30   Class :character  \n Median : 16.50   Median : 10.60   Mode  :character  \n Mean   : 20.21   Mean   : 11.27                     \n 3rd Qu.: 26.30   3rd Qu.: 16.20                     \n Max.   :373.30   Max.   :119.80                     \n NA's   :1346     NA's   :1711                       \n```\n\n\n:::\n:::\n\n\nBut **data visualisation can be an even more powerful tool in expressing statistical properties of our data.**\n\n## Distribution of data\n\nTo begin with, we can **explore the properties of individual variables**, starting with the distribution of values.\n\n**Let's just work in our code `attic/development.R` script for now.** We'll transfer final plots to `analysis.R` when we are happy with them.\n\n## Distribution of `stem_diameter`\n\nLets **start with `stem_diameter` which is a continuous variable**. As such we can **use `geom_density` to plot the distribution of the data.**\n\n\n::: {.cell}\n<iframe src=\"https://ggplot2.tidyverse.org/reference/geom_density.html\" width=\"672\" height=\"400px\" data-external=\"1\"></iframe>\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nindividual %>%\n  ggplot(aes(x = stem_diameter)) +\n  geom_density()\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: Removed 1346 rows containing non-finite outside the scale range\n(`stat_density()`).\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](05c_exploratory_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\nThe **distribution across all our data looks quite skewed towards lower values** and a long tail of larger values and even shows a small dip in a certain range of `stem_diameter`.\n\n**Many statistical tests assume normality** of the data and a **common transformation** to such skewed continuous data might be to **log them**. \n\n**`ggplot` allows us to perform such transformations during plotting** and prints it as part of the variable axes label.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nindividual %>%\n  ggplot(aes(x = log(stem_diameter))) +\n  geom_density()\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: Removed 1346 rows containing non-finite outside the scale range\n(`stat_density()`).\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](05c_exploratory_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\nStill **rather wonky and may well violate assumptions of statistical tests** down the line but it is slightly better than before so **just for demonstration purposes, let's carry on presenting our data on a log scale.**\n\n## Applying aesthetics to geometries\n\nOne thing that can **make such plots visually more appealing** is to **fill in the area under the distribution curve.**\n\nThis also gives us the opportunity to **dig into what exactly the aesthetic mapping in `aes()` is doing.**\n\nLet's say we **wanted to fill in the area with the colour `grey`**. Our **first instinct might me to use `aes()` in `ggplot()` and map aesthetic `fill` to the name of the colour `\"grey\"`.**\n\n\n::: {.cell}\n\n```{.r .cell-code}\nindividual %>%\n  ggplot(aes(x = log(stem_diameter), fill = \"grey\")) +\n  geom_density()\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: Removed 1346 rows containing non-finite outside the scale range\n(`stat_density()`).\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](05c_exploratory_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\nBut this has **unexpected results!** This happens because **we are supplying the colour name within `aes()`**. `aes()` is for **mapping variables to aesthetics** and expects a **variable name in our data or a vector of values**.\n\nHere we are giving it **a single character value** which it converts to a factor. It then uses it's **default function for creating categorical colour scales to assign the first colour in that scale (red) to our single factor level `\"grey\"`.** The important point here is that **R is not interpreting `\"grey\"` as a colour, but as a categorical variable**, as it did for `factor(cyl)`.\n\nTo **specify explicitly the fill colour** of our density geom, we instead supply it as an **argument to our `geom_density()` function, outside of `aes()`**. Let's change both the `colour` of the line and `fill` to `\"grey\"`.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nindividual %>%\n  ggplot(aes(x = log(stem_diameter))) +\n  geom_density(colour = \"grey\", fill = \"grey\")\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: Removed 1346 rows containing non-finite outside the scale range\n(`stat_density()`).\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](05c_exploratory_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\n## Distribution of `height`\n\nWe can **similarly create a density plot for `height`**\n\n\n::: {.cell}\n\n```{.r .cell-code}\nindividual %>%\n  ggplot(aes(x = height)) +\n  geom_density(colour = \"grey\", fill = \"grey\")\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: Removed 1711 rows containing non-finite outside the scale range\n(`stat_density()`).\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](05c_exploratory_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n\nIt's also a bit skewed so lets go ahead and work with `log()` values again.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nindividual %>%\n  ggplot(aes(x = log(height))) +\n  geom_density(colour = \"grey\", fill = \"grey\")\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: Removed 1711 rows containing non-finite outside the scale range\n(`stat_density()`).\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](05c_exploratory_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n\n## Distribution of `growth_form`\n\nIn contrast to `stem_diameter` and `height`, **`growth_form` is a categorical variable.**\n\nAs such, we **use `geom_bar()` to plot a bar plot of the counts of values of each `growth_form` in our data**. \n\nA bar plot **plots categorical data across one axes** and **numeric data** (in this case **counts**) on the other axis.\n\n\n::: {.cell}\n<iframe src=\"https://ggplot2.tidyverse.org/reference/geom_bar.html\" width=\"672\" height=\"400px\" data-external=\"1\"></iframe>\n:::\n\n\nLet's also **map colour aesthetics to growth form.**\n\n\n::: {.cell}\n\n```{.r .cell-code}\nindividual %>%\n  ggplot(aes(x = growth_form, colour = growth_form, fill = growth_form)) +\n  geom_bar()\n```\n\n::: {.cell-output-display}\n![](05c_exploratory_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n:::\n\n\nWe can see that there are **very few entries for `\"liana\"`**. \n\nThere are **also a whole bunch of `NA`s in `growth_form`.** Indeed for our analysis, we'll need values for all three columns, what we call **complete cases**. \n\nSo let's filter our data to:\n- **remove any rows where growth form is `\"liana\"`**.\n- **retain only complete cases, i.e. rows where no `NA`s exist in any columns.\n\nTo do this, we'll use `dplyr::filter()` and introduce a new function, `complete.cases()` which takes a data.frame, (which is why we pass the entire data object with `.`) and returns a logical vector with `TRUE` for rows with complete cases and `FALSE` for rows with incomplete cases. \n\nLet's **assign this new data to a new `analysis_df`** and work with that from now on.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nanalysis_df <- individual %>%\n  filter(complete.cases(.), growth_form != \"liana\")\n```\n:::\n\n\n##### **:floppy_disk: Let's move those data preparation steps to `analysis.R`**\n\n### Ordering bars in a bar plot\n\nLet's also **order our bars in order of ascending counts**. The simplest way to do this is to **convert `growth_form` to a factor and specify the ordering of the factor levels.**\n\nTo do that let's **create a vector of `growth_form` unique values, ordered according to their counts in the raw data.**\n\nWe can do this by using `table` to get the counts, `order` to order them in ascending order and `names` to extract the names!\n\n\n::: {.cell}\n\n```{.r .cell-code}\ngf_levels <- table(analysis_df$growth_form) %>%\n  sort() %>%\n  names()\n```\n:::\n\n\nWe can then **specify the level order when we mutate `growth_form` to a factor** using `gf_levels` **through argument `levels`** in `factor`.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nanalysis_df <- analysis_df %>%\n  mutate(growth_form = factor(growth_form,\n    levels = gf_levels\n  ))\n```\n:::\n\n\n##### **:floppy_disk: Let's move those data preparation steps to `analysis.R`**\n\nLet's have a look at our bar plot now:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nanalysis_df %>%\n  ggplot(aes(x = growth_form, colour = growth_form, fill = growth_form)) +\n  geom_bar()\n```\n\n::: {.cell-output-display}\n![](05c_exploratory_files/figure-html/unnamed-chunk-15-1.png){width=672}\n:::\n:::\n\n\n**The order of the levels in `growth_form` now dictates the order in which the bars are plotted!**\n\n### Swapping axes in a bar plot\n\nFinally, let's just add a few extra touches to make the plot even more visually clear.\n\nLet's **flip the axis by mapping `growth_form` to `y`, that prevents `growth_form` axes labels from overlapping.**\n\nLet's also **remove the superfluous legend** and **reduce the opacity of our bars** so we can see the scales through them\n\n\n::: {.cell}\n\n```{.r .cell-code}\nanalysis_df %>%\n  ggplot(aes(y = growth_form, colour = growth_form, fill = growth_form)) +\n  geom_bar(alpha = 0.5, show.legend = FALSE)\n```\n\n::: {.cell-output-display}\n![](05c_exploratory_files/figure-html/unnamed-chunk-16-1.png){width=672}\n:::\n:::\n\n\nThat's better.\n\n##### **:floppy_disk: Let's keep this plot and move it to our `analysis.R` script as fig 1**.\n\n\n## Plotting multiple densities according to the values of a second variable\n\nWhen **plotting the density distributions we ended up having one plot per variable** with **little understanding of how values where distributed across the various growth forms.**\n\nHowever, **`ggplot` and the grammar of graphics allows us to build more informative plots, by combining the information in categorical variables to present cross variable distributions.**\n\n\nLet's explore what this means by **focusing on the distribution of `stem_diameter` across the `growth_form` categories** in our `development.R`.\n\nWe can **plot out a separate density curve for each growth form** by **mapping categorical variable `grow_form`** to `aes()` argument **`group`.**\n\n\n::: {.cell}\n\n```{.r .cell-code}\nanalysis_df %>%\n  ggplot(aes(x = log(stem_diameter), group = growth_form)) +\n  geom_density()\n```\n\n::: {.cell-output-display}\n![](05c_exploratory_files/figure-html/unnamed-chunk-17-1.png){width=672}\n:::\n:::\n\n\n**Now we have separate distribution curves for each `growth_form`!**\n\nThis first pass is **not however visually easy to interpret**. Let's assign `growth_form` to some additional aesthetics to make the visual encoding clearer.\n\nWe can in fact get rid of the `group` argument and **use `fill` and `colour` instead**. The grouping behaviour is equivalent.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nanalysis_df %>%\n  ggplot(aes(x = log(stem_diameter), colour = growth_form, fill = growth_form)) +\n  geom_density()\n```\n\n::: {.cell-output-display}\n![](05c_exploratory_files/figure-html/unnamed-chunk-18-1.png){width=672}\n:::\n:::\n\n\nTo make things even clearer we can supply additional argument to `geom_density`.\n\nLet's **decrease the opacity of each density geom and trim it to the ranges of values across each `growth_form`.**\n\n\n::: {.cell}\n\n```{.r .cell-code}\nanalysis_df %>%\n  ggplot(aes(x = log(stem_diameter), colour = growth_form, fill = growth_form)) +\n  geom_density(alpha = 0.5, trim = TRUE)\n```\n\n::: {.cell-output-display}\n![](05c_exploratory_files/figure-html/unnamed-chunk-19-1.png){width=672}\n:::\n:::\n\n\nThat's a lot clearer, and now we can see that overall the distribution of `log(stem_diameter)` across growth forms follows a broadly bimodal distribution. However, **the distributions across each growth formal appear more normal**.\n\nTo allow us to **focus more on the individual distributions**, we can use **`facet_wrap()` and formula `~growth_form` to create individual panels** for each growth form on a grid:\n\n\n::: {.cell}\n<iframe src=\"https://ggplot2.tidyverse.org/reference/facet_wrap.html\" width=\"672\" height=\"400px\" data-external=\"1\"></iframe>\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nanalysis_df %>%\n  ggplot(aes(x = log(stem_diameter), colour = growth_form, fill = growth_form)) +\n  geom_density(alpha = 0.5, trim = TRUE) +\n  facet_wrap(~growth_form)\n```\n\n::: {.cell-output-display}\n![](05c_exploratory_files/figure-html/unnamed-chunk-21-1.png){width=672}\n:::\n:::\n\n\n## Encoding multiple distributions with violin plots\n\nAnother way we can present the distribution of a continuous variable in a compact way and grouped according to the value of a categorical variable is to **use a violin plot.**\n\n\n::: {.cell}\n<iframe src=\"https://ggplot2.tidyverse.org/reference/geom_violin.html\" width=\"672\" height=\"400px\" data-external=\"1\"></iframe>\n:::\n\n\nLet's straight away add some colour aesthetics also.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nanalysis_df %>%\n  ggplot(aes(x = log(stem_diameter), y = growth_form, \n             colour = growth_form, fill = growth_form)) +\n  geom_violin(alpha = 0.5, trim = T)\n```\n\n::: {.cell-output-display}\n![](05c_exploratory_files/figure-html/unnamed-chunk-23-1.png){width=672}\n:::\n:::\n\n\n##### Adding statistical summaries with `geom_boxplot()`\n\nWe can go a step further and **add statistical information about our variable by overlaying a boxplot** (or box and whiskers plot). The boxplot compactly displays the distribution of a continuous variable by visualising **five key summary statistics (the median, two hinges and two whiskers)**, and all \"outlying\" points individually.\n\n\n::: {.cell}\n<iframe src=\"https://ggplot2.tidyverse.org/reference/geom_boxplot.html\" width=\"672\" height=\"400px\" data-external=\"1\"></iframe>\n:::\n\n\nLet's also **suppress the legend for the box plot layer and reduce the opacity.**\n\n\n::: {.cell}\n\n```{.r .cell-code}\nanalysis_df %>%\n  ggplot(aes(x = log(stem_diameter), y = growth_form, colour = growth_form, fill = growth_form)) +\n  geom_violin(alpha = 0.5, trim = T) +\n  geom_boxplot(alpha = 0.7, show.legend = FALSE)\n```\n\n::: {.cell-output-display}\n![](05c_exploratory_files/figure-html/unnamed-chunk-25-1.png){width=672}\n:::\n:::\n\n\n- The **central line** in each box corresponds to the **median.** \n- The **lower** and **upper hinges** correspond to the **first and third quartiles** (the 25th and 75th percentiles) and define the **Interquartile range (IQR).**  \n- The whiskers are calculated from the IQR and identify points considered statistical outliers.\n\nAgain, we see the same information but this time we have a much more informative and compact plot.\n\nWe would still need a plot per variable though.\n\nWe **could try and utilise `facet_grid` to combine a plot for each continuous variable `stem_diameter` and `height` into a single plot**. However, **there isn't a variable in the data in the current form that could be used to facet on**. The data is instead held across two separate columns, `stem_diameter` and `height`.\n\n## Pivoting data to longer\n\nTo take advantage of `facet_wrap` we need to **pivot** our data into a **longer format using `pivot_longer`** from package `tidyr`.\n\n\n::: {.cell}\n<iframe src=\"https://tidyr.tidyverse.org/reference/pivot_longer.html\" width=\"672\" height=\"400px\" data-external=\"1\"></iframe>\n:::\n\n\n**`pivot_longer()` \"lengthens\" data, increasing the number of rows and decreasing the number of columns**. We use it to **stack the values of `stem_diameter` and `height` into a column called `value`** and **store the original column names** which define the variable each value relates to in a **new column `var`**. The values of `growth_form` are duplicated and stacked.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nanalysis_df %>%\n  tidyr::pivot_longer(\n    cols = c(stem_diameter, height),\n    names_to = \"var\",\n    values_to = \"value\"\n  )\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 23,252 × 3\n   growth_form      var           value\n   <fct>            <chr>         <dbl>\n 1 single bole tree stem_diameter  17.1\n 2 single bole tree height         15.2\n 3 single bole tree stem_diameter  13.7\n 4 single bole tree height          9.8\n 5 single bole tree stem_diameter  12.3\n 6 single bole tree height          7.7\n 7 single bole tree stem_diameter  12.1\n 8 single bole tree height         15.2\n 9 single bole tree stem_diameter  29.2\n10 single bole tree height         16.7\n# ℹ 23,242 more rows\n```\n\n\n:::\n:::\n\n\nNote that the **number of rows is now twice the size of the original data** because two columns have been stacked. Those columns have also now been removed.\n\nWith data in this format, we can **use variable `var` to create a facet for each variable**.\n\n### Figure 2: Data characteristics of our raw data\n\nLet's add the pivot as a step in our plotting pipeline and **include faceting with `facet_grid`**.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nanalysis_df %>%\n  tidyr::pivot_longer(\n    cols = c(stem_diameter, height),\n    names_to = \"var\",\n    values_to = \"value\"\n  ) %>%\n  ggplot(aes(x = log(value), y = growth_form, colour = growth_form, \n             fill = growth_form)) +\n  geom_violin(alpha = 0.5, trim = T) +\n  geom_boxplot(alpha = 0.7, show.legend = FALSE) +\n  facet_grid(~var)\n```\n\n::: {.cell-output-display}\n![](05c_exploratory_files/figure-html/unnamed-chunk-28-1.png){width=672}\n:::\n:::\n\n\nHurray! **Now we have a super informative plot, containing visual encodings of distributions and statistical summaries for both our continuous variables in one compact plot!**\n\n\n##### **:floppy_disk: Let's keep this plot and move it to our `analysis.R` script as fig 1**.\n\n# Analysis in practice: fitting and visualising a simple linear model\n\nNow that we've explored our variables, it's **time to start looking at the statistical relationship between them.**\n\n## Analysing the relationship between `log(stem_diameter)` and `log(height)`\n\nFirst we **might want to look at the overall relationship between our two continuous variables** and we can start with fitting a simple linear regression model.\n\nIn R, **we use `lm` to fit linear models**. It can be used to carry out regression, single stratum analysis of variance and analysis of covariance.\n\n### Fitting a linear model\n\nWe **specify our model through a formula `log(stem_diameter) ~ log(height)`**. This translates to log stem diameter as a function of height where **`stem_diameter` is the response** variable and **`height` the predictor**.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlm_overall <- lm(log(stem_diameter) ~ log(height), analysis_df)\nlm_overall\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\nlm(formula = log(stem_diameter) ~ log(height), data = analysis_df)\n\nCoefficients:\n(Intercept)  log(height)  \n     0.5609       0.9439  \n```\n\n\n:::\n:::\n\n\nBy default `lm` prints a rather terse summary of the model.\n\nAn **easy way to print nice and tidy outputs of most models in R is by using functions from package `broom`.**\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlm_overall %>%\n  broom::glance()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 1 × 12\n  r.squared adj.r.squared sigma statistic p.value    df logLik    AIC    BIC\n      <dbl>         <dbl> <dbl>     <dbl>   <dbl> <dbl>  <dbl>  <dbl>  <dbl>\n1     0.679         0.679 0.487    24613.       0     1 -8132. 16271. 16293.\n# ℹ 3 more variables: deviance <dbl>, df.residual <int>, nobs <int>\n```\n\n\n:::\n:::\n\n\n`glance()` accepts a model object and returns a tibble with exactly one row of **model summaries**. The summaries are **typically goodness of fit measures, p-values for hypothesis tests on residuals, or model convergence information.**\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlm_overall %>%\n  broom::tidy()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 2 × 5\n  term        estimate std.error statistic   p.value\n  <chr>          <dbl>     <dbl>     <dbl>     <dbl>\n1 (Intercept)    0.561   0.0145       38.7 5.36e-308\n2 log(height)    0.944   0.00602     157.  0        \n```\n\n\n:::\n:::\n\n\n`tidy()` **summarizes information about the components of a model**. In the case of a linear model, components are the **parameters associated with a regression i.e. the intercept and slope.**\n\n### Visualising our overall model\n\nTo **plot the relationship** that the `lm` has fit, we plot a **scatter plot using `geom_point()`** and map `log(height)` to `x` (the predictor) and `log(stem_diameter)` to `y` (the response).\n\nWe can also **add a line to our plot using `geom_smooth()`**. This plots a smooth over the data by default but can **use method `lm` to plot lines using a linear model**.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nanalysis_df %>%\n  ggplot(aes(x = log(height), y = log(stem_diameter))) +\n  geom_point(alpha = 0.2) +\n  geom_smooth(method = \"lm\")\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n`geom_smooth()` using formula = 'y ~ x'\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](05c_exploratory_files/figure-html/unnamed-chunk-32-1.png){width=672}\n:::\n:::\n\n\n#### Changing the theme and adding custom axes labels\n\nLet's bring this closer to publication level by **adding more formal custom axes labels with `xlab()` and `ylab()`** and **changing the theme to the built in theme `theme_linedraw()`.**\n\n\n::: {.cell}\n\n```{.r .cell-code}\nanalysis_df %>%\n  ggplot(aes(x = log(height), y = log(stem_diameter))) +\n  geom_point(alpha = 0.2) +\n  geom_smooth(method = \"lm\") +\n  xlab(\"Log of height (m)\") +\n  ylab(\"Log of stem diameter (cm)\") +\n  theme_linedraw()\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n`geom_smooth()` using formula = 'y ~ x'\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](05c_exploratory_files/figure-html/unnamed-chunk-33-1.png){width=672}\n:::\n:::\n\n\n\n## Including an interaction with `growth_form`\n\nInspecting the plot we can **clearly see sub groups in our data**. We already know that both our variables have very different distributions across `growth_form`. So **let's see if our model improves if we include `growth_form` in our model specification**.\n\n**Growth form is a categorical variable** so when we include it in our regression, **`lm` will fit separate coefficients for our model at every level of the factor**. To include it, we **add it to the predictor side of our formula**. If we include it as an additive effect through `+`, only the intercept will vary across factor levels. If we fit it as an **interaction using `*` both the slope and intercept are allowed to vary**.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlm_growth <- lm(log(stem_diameter) ~ log(height) * growth_form, analysis_df)\n```\n:::\n\n\nWe can again examine our model using `broom`\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlm_growth %>%\n  broom::glance()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 1 × 12\n  r.squared adj.r.squared sigma statistic p.value    df logLik    AIC    BIC\n      <dbl>         <dbl> <dbl>     <dbl>   <dbl> <dbl>  <dbl>  <dbl>  <dbl>\n1     0.799         0.799 0.386     4195.       0    11 -5418. 10862. 10957.\n# ℹ 3 more variables: deviance <dbl>, df.residual <int>, nobs <int>\n```\n\n\n:::\n:::\n\n\nWe can see that model coverage as indicated by `r.squared` is now higher and the `p.value` is still significant\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlm_growth %>%\n  broom::tidy()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 12 × 5\n   term                                   estimate std.error statistic   p.value\n   <chr>                                     <dbl>     <dbl>     <dbl>     <dbl>\n 1 (Intercept)                              0.442     0.0479     9.23  3.16e- 20\n 2 log(height)                              0.391     0.142      2.75  5.99e-  3\n 3 growth_formsmall tree                   -0.255     0.107     -2.38  1.73e-  2\n 4 growth_formsapling                      -0.0318    0.0545    -0.583 5.60e-  1\n 5 growth_formsingle shrub                 -0.945     0.0707   -13.4   1.96e- 40\n 6 growth_formmulti-bole tree               0.904     0.0618    14.6   4.14e- 48\n 7 growth_formsingle bole tree              1.12      0.0521    21.5   7.23e-101\n 8 log(height):growth_formsmall tree        0.561     0.151      3.73  1.93e-  4\n 9 log(height):growth_formsapling          -0.0820    0.155     -0.531 5.96e-  1\n10 log(height):growth_formsingle shrub      0.812     0.148      5.48  4.45e-  8\n11 log(height):growth_formmulti-bole tree   0.245     0.143      1.71  8.68e-  2\n12 log(height):growth_formsingle bole tr…   0.185     0.143      1.30  1.95e-  1\n```\n\n\n:::\n:::\n\n\nWe see the model coefficients for each growth form slope and interaction.\n\nThe first 2 row show the intercept and slope for the first level of `growth_form` ie small shrub which is considered the reference level.\n\nThe rest of the rows show the **intercepts and slopes with respect to the values of the coefficients for small shrub** so they represent differences from the reference level, level 1.\n\n### Visualising our model\n\nTo include the interaction with `growth_form` we **apply a grouping to our scatter plot through aesthetic `colour`.**\n\n\n::: {.cell}\n\n```{.r .cell-code}\nanalysis_df %>%\n  ggplot(aes(x = log(height), y = log(stem_diameter), colour = growth_form)) +\n  geom_point(alpha = 0.1) +\n  geom_smooth(method = \"lm\") +\n  labs(\n    x = \"Log of height (m)\",\n    y = \"Log of stem diameter (cm)\",\n    colour = \"Growth forms\"\n  ) +\n  theme_linedraw()\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n`geom_smooth()` using formula = 'y ~ x'\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](05c_exploratory_files/figure-html/unnamed-chunk-37-1.png){width=672}\n:::\n:::\n\n\nLet's also use the `labs()` function this time to provide custom axes titles as well as  **add a custom title to our colour legend**.\n\nExcellent! We now have specified both models and visualised them! Our analysis is complete.\n\n*NOTE: the geom_smooth method of plotting model lines is not ideal and you will likely take more formal approaches to calculating and plotting confidence intervals. But for the purposes of of this workshop, we'll stick with this.*\n\n****\n\n## Final `analysis.R`\n\n##### **:floppy_disk: Lets add all our models and plots to our `analysis.R` script.**.\n\n\n**Your `analysis.R` script should now look like this.**\n\n\n::: {.cell filename='analysis.R'}\n\n```{.r .cell-code}\n## Setup ----\n# Load libraries\nlibrary(dplyr)\nlibrary(ggplot2)\n# Load data\nindividual <- readr::read_csv(\n  here::here(\"data\", \"individual.csv\")\n) %>%\n  select(stem_diameter, height, growth_form)\n\n## Subset analysis data ----\nanalysis_df <- individual %>%\n  filter(complete.cases(.), growth_form != \"liana\")\n\n## Order growth form levels\ngf_levels <- table(analysis_df$growth_form) %>%\n  sort() %>%\n  names()\nanalysis_df <- analysis_df %>%\n  mutate(growth_form = factor(growth_form,\n    levels = gf_levels\n  ))\n## Plots ----\n## Figure 1: Bar plot of growth forms\nanalysis_df %>%\n  ggplot(aes(\n    y = growth_form, colour = growth_form,\n    fill = growth_form\n  )) +\n  geom_bar(alpha = 0.5, show.legend = FALSE)\n\n## Figure 2: Violin plots of stem diameter and height across growth forms\nanalysis_df %>%\n  tidyr::pivot_longer(\n    cols = c(stem_diameter, height),\n    names_to = \"var\",\n    values_to = \"value\"\n  ) %>%\n  ggplot(aes(\n    x = log(value), y = growth_form,\n    colour = growth_form, fill = growth_form\n  )) +\n  geom_violin(alpha = 0.5, trim = TRUE, show.legend = FALSE) +\n  geom_boxplot(alpha = 0.7, show.legend = FALSE) +\n  facet_grid(~var) +\n  theme_linedraw()\n\n## Fit overall linear model ----\nlm_overall <- lm(\n  log(stem_diameter) ~ log(height),\n  analysis_df\n)\nlm_overall %>%\n  broom::glance()\nlm_overall %>%\n  broom::tidy()\n\n## Plot overall linear model\nanalysis_df %>%\n  ggplot(aes(x = log(height), y = log(stem_diameter))) +\n  geom_point(alpha = 0.2) +\n  geom_smooth(method = \"lm\") +\n  xlab(\"Log of height (m)\") +\n  ylab(\"Log of stem diameter (cm)\") +\n  theme_linedraw()\n\n## Fit linear model with growth form interaction ----\nlm_growth <- lm(\n  log(stem_diameter) ~ log(height) * growth_form,\n  analysis_df\n)\nlm_growth %>%\n  broom::glance()\nlm_growth %>%\n  broom::tidy()\n\n## Plot linear model with growth form interaction\nanalysis_df %>%\n  ggplot(aes(x = log(height), y = log(stem_diameter), colour = growth_form)) +\n  geom_point(alpha = 0.1) +\n  geom_smooth(method = \"lm\") +\n  labs(\n    x = \"Log of height (m)\",\n    y = \"Log of stem diameter (cm)\",\n    colour = \"Growth forms\"\n  ) +\n  theme_linedraw()\n```\n:::\n",
    "supporting": [
      "05c_exploratory_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}