{
  "hash": "1ac9dc2ab12a63d873c9f755e06ea5d1",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Managing Dependencies\"\n---\n\n\n> One of the most important aspects of reproducible research is managing dependencies.\n\nFor your analysis to run, it interacts with:\n\n- **Operating system:** The operating system of your computer.\n\n- **System configurations**: such as locations of libraries and the search path your computer uses to find files and libraries\n\n- **System Level libraries**. These are non-R libraries that R or packages in R you might be using depend on. (for example libraries such as `GEOS`, `GDAL` and `PROJ4` that geospatial R packages like `sf` and `rgeos` depend on). Such external dependencies to R are listed as `System Requirements` in R package `DESCRIPTION` files (e.g have a look at the [relevant line](https://github.com/r-spatial/sf/blob/adf7410a5c55695b4c8db97a5258ec87c931320a/DESCRIPTION#L110) in the `sf` package `DESCRIPTION`.\n\n\n- **R and the R packages your analysis depends on**. For example, the version of R we've been using as well as packages `ggplot2` and `dplyr`.\n\n\nWhen someone else tries to reproduce your analysis on a different computer, if any of these elements differ from what existed on your own system when you last ran your analysis, e.g some of the dependencies are missing, different versions are available or code behaves differently on a different operating system, they may not be able to reproduce your work.\n\n## Managing R dependencies.\n\nYour first consideration should be to ensure you retain information and ideally a way of automatically installing any R package dependencies your code depends on.\n\nAs there is no way to automatically install external system dependencies, you should highlight any such dependencies in your README and ideally provide installation instructions (or links to them). Have a look at the [installation section](https://r-spatial.github.io/sf/#installing) of the  documentation for package `sf`.\n\n\n\n::: {.cell}\n<iframe src=\"https://r-spatial.github.io/sf/#installing\" width=\"672\" height=\"400px\" data-external=\"1\"></iframe>\n:::\n\n\n\n# Minimal approach\n\n\n## Including Session Information\n\nAt the very minimum you could list the packages used in an analysis using `sessionInfo()` at the bottom of an `.qmd` file. This however is not so useful for `.R` scripts (unless you save the output of the function to a separate file). It also doesn't provide executable code for someone else to install the requirements.\n\n## Including an `install.R` script\n\nA more convenient but still not very robust method of managing R dependencies would be to include an executable `install.R` script (like the one I've included for setting up the projects in this course on your local machine) which contains the commands to install all the required dependencies.\n\nHere's the example of `install.R` used to set up the `wood-survey` project\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndependencies <- c(\"assertr\", \"checkmate\", \"cowsay\", \"credentials\", \"data.table\",\n                  \"dataspice\", \"devtools\", \"DT\", \"fs\", \"gapminder\", \"geosphere\",\n                  \"ggthemes\", \"gitcreds\", \"glue\", \"gt\", \"here\", \"janitor\", \"jsonlite\",\n                  \"knitr\", \"leaflet\", \"listviewer\", \"magrittr\", \"plotly\", \"raster\",\n                  \"renv\", \"reprex\", \"rmarkdown\", \"sf\", \"skimr\", \"sloop\",\n                  \"spData\", \"stringr\", \"testthat\", \"tidyr\", \"tidyverse\", \"tmap\",\n                  \"usethis\", \"vroom\")\n\n# install CRAN dependencies\ninstall.packages(dependencies)\n```\n:::\n\n\n**The problem with this is that the versions of packages are not fixed.** Instead, each  time the script is run, the most up to date versions of packages are installed, and R also prompts you to update any packages already installed. **Changes in packages and a general mismatch of versions compared to those used to develop the original code, could cause problems in code execution.**\n\nIn the case of  this website, I want the materials to work with up to date versions of packages. If there are problems with  newer versions, I can correct the materials before I run the course. However, **for a published analysis, using code you don't plan to further develop (and therefore do not require that it tracks the evolution of packages in the  R ecosystem), it would be better to be able to pin exact versions of packages.** That way you can ensure another user will be working with the exact same versions of your dependencies.\n\n# Robust approach\n\n## Managing R dependencies with `renv`\n\nThe `renv` package is a new effort to bring project-local R dependency\nmanagement to your projects.\n\nUnderlying the philosophy of `renv` is that any of your existing workflows\nshould just work as they did before -- `renv` helps manage library paths (and\nother project-specific state) to help isolate your project's R dependencies.\n\n##### `renv` Workflow\n\nThe general workflow when working with `renv` is:\n\n1. Call `renv::init()` to initialize a new project-local environment with a\n   **private R library**,\n\n2. Work in the project as normal, installing and removing new R packages as\n   they are needed in the project,\n\n3. Call `renv::snapshot()` to save the state of the project library to the\n   lockfile (called `renv.lock`),\n\n4. Continue working on your project, installing and updating R packages as\n   needed.\n\n5. Call `renv::snapshot()` again to save the state of your project library if\n   your attempts to update R packages were successful, or call `renv::restore()`\n   to revert to the previous state as encoded in the lockfile if your attempts\n   to update packages introduced some new problems.\n\nThe `renv::init()` function attempts to ensure the newly-created project\nlibrary includes all R packages currently used by the project. It does this\nby crawling R files within the project for dependencies with the\n`renv::dependencies()` function. The discovered packages are then installed\ninto the project library with the `renv::hydrate()` function, which will also\nattempt to save time by copying packages from your user library (rather than\nre-installing from CRAN) as appropriate.\n\nCalling `renv::init()` will also write out the infrastructure necessary to\nautomatically load and use the private library for new R sessions launched\nfrom the project root directory. This is accomplished by creating (or amending)\na project-local `.Rprofile` with the necessary code to load the project when\nthe R session is started.\n\nThe following files are written to and used by projects using `renv`:\n\n| **File**          | **Usage**                                                                           |\n| ----------------- | ----------------------------------------------------------------------------------- |\n| `.Rprofile`       | Used to activate `renv` for new R sessions launched in the project.                 |\n| `renv.lock`       | The lockfile, describing the state of your project's library at some point in time. |\n| `renv/activate.R` | The activation script run by the project `.Rprofile`.                               |\n| `renv/library`    | The private project library.                                                        |\n\n\n##### Reproducibility with `renv`\n\nUsing `renv`, it's possible to \"save\" and \"load\" the state of your project\nlibrary. More specifically, you can use:\n\n- `renv::snapshot()` to save the state of your project to `renv.lock`; and\n  \n- `renv::restore()` to restore the state of your project from `renv.lock`.\n\nFor each package used in your project, `renv` will record the package version,\nand (if known) the external source from which that package can be retrieved.\n`renv::restore()` uses that information to retrieve and re-install those\npackages in your project.\n\n\n#### Using `renv` in our `wood-survey` project\n\nLet's go back into our `wood-survey` project and capture our dependencies into a project level R package library. We do this by first initialising `renv`\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrenv::init()\n```\n:::\n\n\nThe first time you run `renv::init()` in a project, `renv` will give you a bit of an orientation:\n\n```\nrenv: Project Environments for R\n\nWelcome to renv! It looks like this is your first time using renv.\nThis is a one-time message, briefly describing some of renv's functionality.\n\nrenv will write to files within the active project folder, including:\n\n  - A folder 'renv' in the project directory, and\n  - A lockfile called 'renv.lock' in the project directory.\n\nIn particular, projects using renv will normally use a private, per-project\nR library, in which new packages will be installed. This project library is\nisolated from other R libraries on your system.\n\nIn addition, renv will update files within your project directory, including:\n\n  - .gitignore\n  - .Rbuildignore\n  - .Rprofile\n\nFinally, renv maintains a local cache of data on the filesystem, located at:\n\n  - \"/cloud/home/r42480/.cache/R/renv\"\n\nThis path can be customized: please see the documentation in `?renv::paths`.\n\nPlease read the introduction vignette with `vignette(\"renv\")` for more information.\nYou can browse the package documentation online at https://rstudio.github.io/renv/.\n```\n\n\nOnce you continue with initialisation, `renv` will create a project specific library and infrastructure to manage dependencies and snapshot any dependencies it detects we are using in our project in the `renv.lock` file.\n\n```\n- \"/cloud/home/r42480/.cache/R/renv\" has been created.\n- Linking packages into the project library ... [93/93] Done!\n- Resolving missing dependencies ... \n# Installing packages ---------------------------------------\nThe following package(s) will be updated in the lockfile:\n\n# CRAN ------------------------------------------------------\n- lattice        [* -> 0.22-5]\n- MASS           [* -> 7.3-60.0.1]\n- Matrix         [* -> 1.6-5]\n- mgcv           [* -> 1.9-1]\n- nlme           [* -> 3.1-164]\n\n# RSPM ------------------------------------------------------\n- assertr        [* -> 3.0.1]\n- backports      [* -> 1.4.1]\n- base64enc      [* -> 0.1-3]\n- bigD           [* -> 0.2.0]\n- bit            [* -> 4.0.5]\n- bit64          [* -> 4.0.5]\n- bitops         [* -> 1.0-7]\n- broom          [* -> 1.0.5]\n- bslib          [* -> 0.7.0]\n- cachem         [* -> 1.0.8]\n- checkmate      [* -> 2.3.1]\n- cli            [* -> 3.6.2]\n- clipr          [* -> 0.8.0]\n- colorspace     [* -> 2.1-0]\n- commonmark     [* -> 1.9.1]\n- cpp11          [* -> 0.4.7]\n- crayon         [* -> 1.5.2]\n- curl           [* -> 5.2.1]\n- digest         [* -> 0.6.35]\n- dplyr          [* -> 1.1.4]\n- ellipsis       [* -> 0.3.2]\n- evaluate       [* -> 0.23]\n- fansi          [* -> 1.0.6]\n- farver         [* -> 2.1.1]\n- fastmap        [* -> 1.1.1]\n- fontawesome    [* -> 0.5.2]\n- fs             [* -> 1.6.3]\n- generics       [* -> 0.1.3]\n- geosphere      [* -> 1.5-18]\n- ggplot2        [* -> 3.5.0]\n- glue           [* -> 1.7.0]\n- gt             [* -> 0.10.1]\n- gtable         [* -> 0.3.4]\n- here           [* -> 1.0.1]\n- highr          [* -> 0.10]\n- hms            [* -> 1.1.3]\n- htmltools      [* -> 0.5.8]\n- htmlwidgets    [* -> 1.6.4]\n- isoband        [* -> 0.2.7]\n- janitor        [* -> 2.2.0]\n- jquerylib      [* -> 0.1.4]\n- jsonlite       [* -> 1.8.8]\n- juicyjuice     [* -> 0.1.0]\n- knitr          [* -> 1.45]\n- labeling       [* -> 0.4.3]\n- lifecycle      [* -> 1.0.4]\n- lubridate      [* -> 1.9.3]\n- magrittr       [* -> 2.0.3]\n- markdown       [* -> 1.12]\n- memoise        [* -> 2.0.1]\n- mime           [* -> 0.12]\n- munsell        [* -> 0.5.1]\n- pillar         [* -> 1.9.0]\n- pkgconfig      [* -> 2.0.3]\n- prettyunits    [* -> 1.2.0]\n- progress       [* -> 1.2.3]\n- purrr          [* -> 1.0.2]\n- R6             [* -> 2.5.1]\n- rappdirs       [* -> 0.3.3]\n- RColorBrewer   [* -> 1.1-3]\n- Rcpp           [* -> 1.0.12]\n- reactable      [* -> 0.4.4]\n- reactR         [* -> 0.5.0]\n- readr          [* -> 2.1.5]\n- renv           [* -> 1.0.7]\n- rlang          [* -> 1.1.3]\n- rmarkdown      [* -> 2.26]\n- rprojroot      [* -> 2.0.4]\n- sass           [* -> 0.4.9]\n- scales         [* -> 1.3.0]\n- snakecase      [* -> 0.11.1]\n- sp             [* -> 2.1-3]\n- stringi        [* -> 1.8.3]\n- stringr        [* -> 1.5.1]\n- tibble         [* -> 3.2.1]\n- tidyr          [* -> 1.3.1]\n- tidyselect     [* -> 1.2.1]\n- timechange     [* -> 0.3.0]\n- tinytex        [* -> 0.50]\n- tzdb           [* -> 0.4.0]\n- utf8           [* -> 1.2.4]\n- V8             [* -> 4.4.2]\n- vctrs          [* -> 0.6.5]\n- viridisLite    [* -> 0.4.2]\n- vroom          [* -> 1.6.5]\n- withr          [* -> 3.0.0]\n- xfun           [* -> 0.43]\n- xml2           [* -> 1.3.6]\n- yaml           [* -> 2.3.8]\n\nThe version of R recorded in the lockfile will be updated:\n- R              [* -> 4.3.3]\n\n- Lockfile written to \"/cloud/project/renv.lock\".\n\nRestarting R session...\n\n- Project '/cloud/project' loaded. [renv 1.0.7]\n```\n\nOur project now also contains the infrastructure that powers `renv` dependency management:\n```\n.\n├── .Rprofile\n├── renv\n│   ├── activate.R\n│   ├── library\n│   │   └── R-4.3\n│   │       └── x86_64-pc-linux-gnu\n│   └── settings.json\n└── renv.lock\n```\n\nThe `renv.lock` contains a list of names and versions of packages used in our project. \n\nThe folder `renv/library/R-4.3` contains the project specific library of installed packages for the R version the analysis is currently being performed on. This is never committed to git (it is by default ignored). Rather, we commit the rest of the files (`renv.lock` file, the `.Rprofile` file and the `renv/activate.R`). Making these available means others users of your code will have the appropriate packages installed in their own local library when the download and use your code.\n\n## Add Installation Instructions in README\n\nTo let others know we are using `renv` in our project, it's good to include Installation Instructions in the README with instructions on how to set up the project library using `renv` if they download our materials.\n\nAdd the following to your README:\n\n````\n## Installation\n\nThis project manages dependencies through `renv`. To restore dependencies, use:\n\n```{{r}}\n# install.packages(\"renv\")\nrenv::restore()\n```\n\n````\n\n**So let's commit all the files `renv::init()` created**\n\nFinally, if you carry on working on your analysis and install new packages, call `renv::snapshot()` to save the state of the project library.\n\n\n# Advanced - Capturing computational environments\n\nWhat we've discussed above only relates to managing R package dependencies. As mentioned though, problems can also arise form differences in the wider computational environment (operating system, system libraries, system configurations, version of R).\n\nMore robust ways of capturing computational environments can be achieved through using technologies like **Docker containers** or services like **Binder**.\n\n## Docker\n\n> #### standardized units of software that **package up everything needed to run an application:** _code, runtime, system tools, system libraries_ and settings in a lightweight, standalone, executable package \n\nDocker containers allow a researcher to package up a project with all of the parts it needs - such as libraries, dependencies, and system settings - and ship it all out as one package.\n\n\n\n![](assets/docker_workflow.png)\n\n- #### **Dockerfile**: Text file containing recipe for setting up computation environment.\n\n- #### **Docker Image**: Executable **built** from the **Dockerfile** with all required dependencies installed. Can have many images from the same `Dockerfile`.\n\n- #### **Docker Container**: **Docker Images** become containers at **runtime**\n\nFor a detailed discussion of the elements of a reproducible analysis and a more advanced example of how to use docker to capture them, have a look at the [dependency chapter](https://rr-mrc-bsu.github.io/reproducible-research/dependency-management.html) in the [A Reproducible Research Compendium ebook](https://rr-mrc-bsu.github.io/reproducible-research/) or the [Containers](https://the-turing-way.netlify.app/reproducible-research/renv/renv-containers.html) chapter in the Turing Way. There's also a paper on [Using Docker Containers to Improve Reproducibility in Software Engineering Research](https://ieeexplore.ieee.org/document/7883438)\n\n## package `containerit`\n\nAlso, check out package `containerit` which relies on Docker and automatically generates a container Dockerfile, or “recipe”, with setup instructions to recreate a runtime environment based on a given R session, R script, R Markdown file or workspace directory. \n\n\n::: {.cell}\n<iframe src=\"https://o2r.info/containerit/articles/containerit.html\" width=\"672\" height=\"400px\" data-external=\"1\"></iframe>\n:::\n\n\n\n## Binder\n\nThe [mybinder](https://mybinder.org/) service turn a Git repo into a collection of interactive notebooks or can even launch Rstudio in the cloud! Check out this [video](https://www.youtube.com/watch?v=a5i42lSj-L4) to find out more about how it works.\n\n\n::: {.cell}\n::: {.cell-output-display}\n![**Fig. 23** Figure credit: [Juliette Taka, Logilab and the OpenDreamKit project](https://opendreamkit.org/2017/11/02/use-case-publishing-reproducible-notebooks/)](assets/binder_comic.png){width=1754}\n:::\n:::\n\n\n\nTo learn more about binder and how to prepare projects to run on the service, have a look at the Turing Way [chapter on Binder](https://the-turing-way.netlify.app/reproducible-research/renv/renv-binder.html) and the [From Zero to Binder in R!](https://github.com/alan-turing-institute/the-turing-way/blob/master/workshops/boost-research-reproducibility-binder/workshop-presentations/zero-to-binder-r.md) tutorial.\n\nALso, check out package [`holepunch` on GitHub](https://github.com/karthik/holepunch) for making your projects Binder ready.\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}